Vagrant.configure("2") do |config|
(1..2).each do |i|
config.vm.define "node#{i}" do |node|
node.vm.box = "generic/ubuntu2204"
config.vm.boot_timeout = 600
# Red privada con IP fija
node.vm.network "private_network", ip: "192.168.33.#{10 + i}"
node.vm.network "forwarded_port", guest: 22, host: 2222 + i, auto_correct: true
# Recursos hardware
node.vm.provider "virtualbox" do |vb|
vb.memory = "1024"
vb.cpus = 2
vb.gui = true
end
# Evita que Vagrant genere claves por defecto
node.ssh.insert_key = false
# 1. INSTALAR OpenSSH primero
node.vm.provision "shell", run: "once", inline: <<-SHELL
apt-get update
apt-get install -y openssh-server
SHELL
# 2. COPIAR LA CLAVE PRIVADA GENERADA EN EL HOST a la VM
node.vm.provision "file", run: "once", source:
"#{Dir.home}/.ssh/vagrant_vm_key", destination: "/home/vagrant/host_rsa_key"
# 3. COPIAR LA CLAVE PÚBLICA AL USUARIO vagrant
node.vm.provision "file", run: "once", source:
"#{Dir.home}/.ssh/vagrant_vm_key.pub", destination:
"/home/vagrant/.ssh/vagrant_vm_key.pub"
# 4. PROVISIONER: Eliminar claves antiguas, mover la nueva y configurar SSH
node.vm.provision "shell", run: "once", inline: <<-SHELL
# Borrar cualquier otra clave generada automáticamente por OpenSSH
sudo rm -f /etc/ssh/ssh_host_*
# Mover la clave privada RSA generada en el host al directorio correcto
sudo mv /home/vagrant/host_rsa_key /etc/ssh/ssh_host_rsa_key
sudo chown root:root /etc/ssh/ssh_host_rsa_key
sudo chmod 600 /etc/ssh/ssh_host_rsa_key
# Agregar la clave pública al usuario vagrant
cat /home/vagrant/.ssh/vagrant_vm_key.pub >>
/home/vagrant/.ssh/authorized_keys
chmod 600 /home/vagrant/.ssh/authorized_keys
chown vagrant:vagrant /home/vagrant/.ssh/authorized_keys
# Ajustar configuración SSHD para que solo use esta clave RSA
sudo sed -i '/^HostKey/d' /etc/ssh/sshd_config
echo 'HostKey /etc/ssh/ssh_host_rsa_key' | sudo tee -a /etc/ssh/sshd_config
# Configurar autenticación SSH (permitir solo clave pública)
sudo sed -i 's/#PubkeyAuthentication yes/PubkeyAuthentication yes/'
/etc/ssh/sshd_config
sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication no/'
/etc/ssh/sshd_config
# Reiniciar servidor SSH para aplicar cambios
sudo systemctl restart sshd
sudo loadkeys es
SHELL
# Opciones SSH adicionales para evitar prompt interno de Vagrant
node.ssh.extra_args = ["-o StrictHostKeyChecking=no", "-o
UserKnownHostsFile=/dev/null"]
end
end
end